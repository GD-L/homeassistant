- trigger:
    - platform: time_pattern
      minutes: "*"
    - platform: homeassistant
      event: start
    - platform: event
      event_type: event_template_reloaded
  action: 
    - service: weather.get_forecasts
      target:
        entity_id: weather.krdu_daynight
      data:
        type: twice_daily
      response_variable: daily_forecast
  sensor:
    - name: Sample Weather
      unique_id: sample_weather
      default_entity_id: sensor.sample_weather
      state: "{{ states('weather.krdu_daynight') }}"
      attributes:
        desc: "{{ state_attr('weather.krdu_daynight', 'forecast') }}"
    - name: Weather Daily
      unique_id: home_daily
      default_entity_id: sensor.weather_daily
      state: "{{ states('weather.krdu_daynight') }}"
      attributes:
        temperature: "{{ state_attr('weather.krdu_daynight', 'temperature') }}"
        dew_point: "{{ state_attr('weather.krdu_daynight', 'dew_point') }}"
        temperature_unit: "{{ state_attr('weather.krdu_daynight', 'temperature_unit') }}"
        humidity: "{{ state_attr('weather.krdu_daynight', 'humidity') }}"
        cloud_coverage: "{{ state_attr('weather.krdu_daynight', 'cloud_coverage') }}"
        pressure: "{{ state_attr('weather.krdu_daynight', 'pressure') }}"
        pressure_unit: "{{ state_attr('weather.krdu_daynight', 'pressure_unit') }}"
        wind_bearing: "{{ state_attr('weather.krdu_daynight', 'wind_bearing') }}"
        wind_gust_speed: "{{ state_attr('weather.krdu_daynight', 'wind_gust_speed') }}"
        wind_speed: "{{ state_attr('weather.krdu_daynight', 'wind_speed') }}"
        wind_speed_unit: "{{ state_attr('weather.krdu_daynight', 'wind_speed_unit') }}"
        visibility: "{{ state_attr('weather.krdu_daynight', 'visibility') }}"
        visibility_unit: "{{ state_attr('weather.krdu_daynight', 'visibility_unit') }}"
        precipitation: "{{ state_attr('weather.krdu_daynight', 'precipitation') }}"
        precipitation_unit: "{{ state_attr('weather.krdu_daynight', 'precipitation_unit') }}"
        forecast: "{{ daily_forecast.forecast[:5] }}"

- sensor:
    - name: Current Temp
      unique_id: currenttemp
      default_entity_id: sensor.currenttemp
      unit_of_measurement: "°F"
      state: "{{ state_attr('weather.krdu_daynight', 'temperature') }}"

    - name: Current Humidity
      unique_id: currenthumid
      default_entity_id: sensor.currenthumid
      unit_of_measurement: "%"
      state: "{{ state_attr('weather.krdu_daynight', 'humidity') }}"
    
    - name: Dew Point
      unique_id: dew_point
      default_entity_id: sensor.dew_point
      unit_of_measurement: "°F"
      state: >-
        {% set T1 = state_attr('weather.downstairs', 'temperature') | float %}
        {% set T1_C = (T1 - 32) / 1.8 %}
        {% set RH1 = state_attr('weather.downstairs', 'humidity') | float %}
        {% set B1 = (log(RH1 / 100) + ((17.27 * T1_C) / (237.3 + T1_C))) / 17.27 %}
        {% set DP = ((237.3 * B1) / (1 - B1)) %}
        {{((DP * 1.8) + 32) | round(1)}}

    - name: Sunset
      unique_id: sunset
      default_entity_id: sensor.sunset
      state: >-
        {% set timestamp = as_timestamp(state_attr('sun.sun', 'next_setting')) | timestamp_custom("%H:%M") %} 
        {{ timestamp }}

    - name: Sunrise
      unique_id: sunrise
      default_entity_id: sensor.sunrise
      state: >-
        {% set timestamp = as_timestamp(state_attr('sun.sun', 'next_rising')) | timestamp_custom("%H:%M") %} 
        {{ timestamp }}
